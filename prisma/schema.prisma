// Barbershop Database Schema
// Code: English (en-US) | UI Labels: Portuguese (pt-BR)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// RBAC (Role-Based Access Control)
// ============================================

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  password          String
  name              String
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  // Relations
  groups            UserGroup[]
  passwordResets    PasswordReset[]
  createdBookings   Booking[]          @relation("CreatedBy")
  
  @@map("users")
}

model Group {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // Relations
  users       UserGroup[]
  permissions GroupPermission[]
  
  @@map("groups")
}

model Permission {
  id          Int              @id @default(autoincrement())
  resource    String           // e.g., "services", "bookings", "barbers"
  action      String           // "view", "create", "update", "delete"
  description String?
  
  // Relations
  groups      GroupPermission[]
  
  @@unique([resource, action])
  @@map("permissions")
}

model UserGroup {
  userId    String
  groupId   Int
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  @@id([userId, groupId])
  @@map("user_groups")
}

model GroupPermission {
  groupId      Int
  permissionId Int
  createdAt    DateTime @default(now())
  
  // Relations
  group        Group      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@id([groupId, permissionId])
  @@map("group_permissions")
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([userId])
  @@map("password_resets")
}

// ============================================
// SERVICES & CATEGORIES
// ============================================

model ServiceCategory {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  services    Service[]
  
  @@map("service_categories")
}

model Service {
  id          Int             @id @default(autoincrement())
  categoryId  Int
  name        String
  description String?
  duration    Int             // Duration in minutes
  price       Decimal         @db.Decimal(10, 2)
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  // Relations
  category    ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  bookings    Booking[]
  availability BarberAvailability[]
  
  @@map("services")
}

// ============================================
// BARBERS
// ============================================

model Barber {
  id          Int                  @id @default(autoincrement())
  name        String
  email       String?              @unique
  phone       String?
  bio         String?              @db.Text
  photoUrl    String?
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  
  // Relations
  bookings    Booking[]
  availability BarberAvailability[]
  exceptions  AvailabilityException[]
  
  @@map("barbers")
}

// ============================================
// AVAILABILITY & EXCEPTIONS
// ============================================

enum RecurrenceType {
  DAILY
  WEEKLY
  MONTHLY
}

enum DayOfWeek {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

model BarberAvailability {
  id              Int              @id @default(autoincrement())
  barberId        Int
  serviceId       Int?             // null = available for all services
  recurrenceType  RecurrenceType
  dayOfWeek       DayOfWeek?       // For WEEKLY recurrence
  dayOfMonth      Int?             // For MONTHLY recurrence (1-31)
  startTime       String           // Format: "HH:MM" (e.g., "09:00")
  endTime         String           // Format: "HH:MM" (e.g., "18:00")
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Relations
  barber          Barber           @relation(fields: [barberId], references: [id], onDelete: Cascade)
  service         Service?         @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  
  @@map("barber_availability")
}

enum ExceptionType {
  BLOCKED      // Barber not available (holiday, vacation, etc.)
  SPECIAL      // Special hours (open on holiday, extended hours, etc.)
}

model AvailabilityException {
  id          Int            @id @default(autoincrement())
  barberId    Int
  date        DateTime       @db.Date
  type        ExceptionType
  startTime   String?        // null for BLOCKED, required for SPECIAL
  endTime     String?        // null for BLOCKED, required for SPECIAL
  reason      String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  // Relations
  barber      Barber         @relation(fields: [barberId], references: [id], onDelete: Cascade)
  
  @@unique([barberId, date])
  @@map("availability_exceptions")
}

// ============================================
// BOOKINGS
// ============================================

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

model Booking {
  id              String         @id @default(cuid())
  barberId        Int
  serviceId       Int
  createdBy       String?        // User who created (can be null for public bookings)
  customerName    String
  customerEmail   String?
  customerPhone   String?
  scheduledAt     DateTime
  status          BookingStatus  @default(PENDING)
  notes           String?        @db.Text
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  barber          Barber         @relation(fields: [barberId], references: [id], onDelete: Restrict)
  service         Service        @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  creator         User?          @relation("CreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  
  @@unique([barberId, scheduledAt])
  @@index([scheduledAt])
  @@index([status])
  @@map("bookings")
}

// ============================================
// PRODUCTS & CATEGORIES
// ============================================

model ProductCategory {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  products    Product[]
  
  @@map("product_categories")
}

model Product {
  id          Int              @id @default(autoincrement())
  categoryId  Int
  name        String
  description String?          @db.Text
  price       Decimal          @db.Decimal(10, 2)
  stock       Int              @default(0)
  imageUrl    String?
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // Relations
  category    ProductCategory  @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  
  @@map("products")
}

// ============================================
// COURSES
// ============================================

enum CourseType {
  PRESENCIAL
  ONLINE
}

model Course {
  id              Int          @id @default(autoincrement())
  name            String
  description     String?      @db.Text
  type            CourseType
  durationHours   Int          // Duration in hours
  price           Decimal      @db.Decimal(10, 2)
  imageUrl        String?
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@map("courses")
}

// ============================================
// ESTABLISHMENT SETTINGS
// ============================================

model EstablishmentSettings {
  id                  Int      @id @default(1)
  name                String   @default("ED Barbearia")
  openingHours        String   @db.Text // JSON format: {"monday": "09:00-18:00", ...}
  address             String   @db.Text
  latitude            Decimal  @db.Decimal(10, 7)
  longitude           Decimal  @db.Decimal(10, 7)
  instagramUrl        String?
  instagramUsername   String?
  phone               String?
  email               String?
  updatedAt           DateTime @updatedAt
  
  @@map("establishment_settings")
}
